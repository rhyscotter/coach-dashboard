<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Coach Dashboard</title>
<style>
:root{
  --bg:#0b0d10;
  --ink:#ffffff;
  --muted:rgba(255,255,255,.62);
  --line:rgba(255,255,255,.10);
  --radius:26px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:
    radial-gradient(900px 500px at 15% 0%, rgba(255,255,255,.08), transparent 55%),
    radial-gradient(900px 500px at 85% 0%, rgba(255,255,255,.06), transparent 55%),
    var(--bg);
  color:var(--ink);
}
.top{
  position:sticky;top:0;z-index:10;
  backdrop-filter: blur(14px);
  background: rgba(11,13,16,.72);
  border-bottom:1px solid var(--line);
}
.topInner{
  max-width:1200px;margin:0 auto;
  padding:16px 20px;
  display:flex;align-items:center;justify-content:space-between;
}
.kicker{font-size:11px;font-weight:900;letter-spacing:1.6px;text-transform:uppercase;}
.subkicker{margin-top:6px;font-size:12px;color:var(--muted);font-weight:650;}
.pill{
  padding:10px 14px;border:1px solid var(--line);border-radius:999px;
  background:rgba(255,255,255,.04);font-size:12px;font-weight:700;
}

.page{max-width:1200px;margin:0 auto;padding:34px 20px 80px;}
.hero{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:18px;}
.name{font-size:48px;font-weight:950;letter-spacing:-2px;line-height:1;}
.tag{
  padding:10px 14px;border-radius:999px;border:1px solid var(--line);
  background:rgba(255,255,255,.04);font-size:12px;font-weight:900;
  letter-spacing:1px;text-transform:uppercase;
}

.grid{
  display:grid;
  grid-template-columns: 1.35fr 0.65fr;
  gap:14px;
}
@media(max-width:980px){ .grid{grid-template-columns:1fr;} }

.stack{display:grid;gap:14px;}

.card{
  border:1px solid var(--line);
  border-radius:var(--radius);
  background:rgba(255,255,255,.03);
  padding:20px;
  position:relative;
  overflow:hidden;
}
.cardStrong{
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
}
.sectionTitle{
  font-size:11px;font-weight:900;letter-spacing:1.4px;text-transform:uppercase;color:var(--muted);
}
.big{margin-top:12px;font-size:28px;font-weight:950;letter-spacing:-1px;}
.sub{margin-top:10px;font-size:13px;color:var(--muted);white-space:pre-wrap;line-height:1.45;}

.row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
.select{
  padding:12px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.04);color:#fff;font-weight:800;letter-spacing:.2px;
  outline:none;min-width:240px;
}
.select option{color:#000;}

.photoRow{display:flex;gap:14px;align-items:center;margin-top:14px;}
.avatar{
  width:92px;height:92px;border-radius:26px;overflow:hidden;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.05);
}
.avatar img{width:100%;height:100%;object-fit:cover}
.fileRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}

.btn{
  padding:12px 16px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.05);
  color:#fff;font-weight:900;letter-spacing:.8px;font-size:12px;text-transform:uppercase;
  cursor:pointer;transition:all .25s ease;
}
.btn:hover{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.30);transform:translateY(-2px);}
.btn:active{transform:translateY(0px);}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}

.toast{
  position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
  background:rgba(0,0,0,.68);border:1px solid rgba(255,255,255,.12);
  padding:12px 14px;border-radius:14px;color:#fff;font-weight:750;font-size:12px;
  backdrop-filter: blur(10px);
  display:none;
}

/* Schedule buttons row */
.scheduleActions{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap;}
</style>
</head>

<body>

<div class="top">
  <div class="topInner">
    <div>
      <div class="kicker" id="roleText">ROLE: Coach</div>
      <div class="subkicker" id="clubText">CLUB: —</div>
    </div>
    <div class="pill" id="today">—</div>
  </div>
</div>

<div class="page">
  <div class="hero">
    <div class="name" id="coachName">LOADING</div>
    <div class="tag">COACH OPS</div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="stack">
      <!-- Team switch -->
      <div class="card">
        <div class="sectionTitle">Team</div>
        <div class="row" style="margin-top:10px;">
          <select class="select" id="teamSelect"></select>

          <div class="scheduleActions">
            <button class="btn" id="openScheduleListBtn">Schedule (List)</button>
            <button class="btn" id="openScheduleCalBtn">Schedule (Calendar)</button>
          </div>
        </div>
        <div class="sub" id="teamHint">Choose a team to load the next event.</div>
      </div>

      <!-- Next event -->
      <div class="card cardStrong">
        <div class="sectionTitle">Next Event</div>
        <div class="big" id="eventTitle">—</div>
        <div class="sub" id="eventMeta">—</div>
      </div>

      <!-- Alert -->
      <div class="card">
        <div class="sectionTitle">Club Alert</div>
        <div class="big" id="alertTitle">—</div>
        <div class="sub" id="alertMsg">—</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="stack">
      <!-- Profile -->
      <div class="card">
        <div class="sectionTitle">Coach Profile</div>

        <div class="photoRow">
          <div class="avatar">
            <img id="avatarImg" alt="Coach photo"/>
          </div>

          <div style="flex:1;">
            <div class="big" style="font-size:22px;margin-top:0;" id="coachMetaName">—</div>
            <div class="sub" id="coachMetaClub">—</div>

            <div class="fileRow" style="margin-top:12px;">
              <input id="fileInput" type="file" accept="image/*" />
              <button class="btn" id="savePhotoBtn" disabled>Save Photo</button>
            </div>

            <div class="sub" id="photoStatus" style="margin-top:10px;display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let state = null;
let pendingDataUrl = "";

function post(type,payload={}){ window.parent.postMessage({type,payload},"*"); }

function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=String(msg||"");
  t.style.display="block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer=setTimeout(()=>{t.style.display="none";},2200);
}

function render(){
  if(!state) return;

  document.getElementById("clubText").textContent = "CLUB: " + (state.clubSlug || "—");
  document.getElementById("today").textContent = state.today || "—";

  const coachName = ((state.coach?.firstName||"") + " " + (state.coach?.lastName||"")).trim() || "COACH";
  document.getElementById("coachName").textContent = coachName.toUpperCase();
  document.getElementById("coachMetaName").textContent = coachName;
  document.getElementById("coachMetaClub").textContent = (state.clubSlug || "").toUpperCase();

  // photo
  const photoUrl = (state.coach?.photoUrl || "").trim();
  document.getElementById("avatarImg").src = photoUrl || "data:image/svg+xml;base64," + btoa(`
    <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200">
      <rect width="100%" height="100%" fill="#111"/>
      <circle cx="100" cy="85" r="38" fill="#222"/>
      <rect x="45" y="130" width="110" height="50" rx="25" fill="#222"/>
    </svg>
  `);

  // team dropdown
  const sel = document.getElementById("teamSelect");
  const teams = Array.isArray(state.teams) ? state.teams : [];
  const selected = state.selectedTeamId || "";

  sel.innerHTML = teams.map(t => {
    const id = String(t.id||"");
    const name = String(t.name||id||"");
    const isSel = id === selected ? "selected" : "";
    return `<option value="${escapeHtml(id)}" ${isSel}>${escapeHtml(name)}</option>`;
  }).join("");

  // next event
  const ev = state.nextEvent;
  document.getElementById("eventTitle").textContent = ev?.title || "No upcoming events";
  document.getElementById("eventMeta").textContent = ev
    ? `${ev.date || ""}${ev.time ? " • " + ev.time : ""}${ev.location ? "\n" + ev.location : ""}${ev.attendanceExpected ? "\nExpected: " + ev.attendanceExpected : ""}`
    : "—";

  // alert
  const a = state.alert;
  document.getElementById("alertTitle").textContent = a?.title || "No alerts";
  document.getElementById("alertMsg").textContent = a?.message || "—";
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// Incoming messages from Wix
window.addEventListener("message",(e)=>{
  const m=e.data||{};
  if(m.type==="STATE"){
    state=m.payload;
    render();
  }
  if(m.type==="TOAST"){
    toast(m.payload?.message || "OK");
  }
  if(m.type==="PHOTO_SAVED"){
    const ok = !!m.payload?.ok;
    const statusEl = document.getElementById("photoStatus");
    statusEl.style.display="block";
    statusEl.textContent = ok ? "Saved." : ("Upload failed: " + (m.payload?.message || "Unknown"));
    if(ok && m.payload?.url){
      // update UI immediately
      document.getElementById("avatarImg").src = m.payload.url;
      pendingDataUrl = "";
      document.getElementById("savePhotoBtn").disabled = true;
    }
    setTimeout(()=>{ statusEl.style.display="none"; }, 2500);
  }
});

// UI events
document.getElementById("teamSelect").addEventListener("change",(ev)=>{
  const teamId = ev.target.value;
  post("SELECT_TEAM",{ teamId });
});

document.getElementById("openScheduleListBtn").addEventListener("click",()=>{
  post("OPEN_SCHEDULE_LIST",{});
});

document.getElementById("openScheduleCalBtn").addEventListener("click",()=>{
  post("OPEN_SCHEDULE_CALENDAR",{});
});

document.getElementById("fileInput").addEventListener("change", async (ev)=>{
  const f = ev.target.files?.[0];
  if(!f) return;

  // convert to dataUrl
  const reader = new FileReader();
  reader.onload = () => {
    pendingDataUrl = reader.result;
    document.getElementById("avatarImg").src = pendingDataUrl; // preview
    document.getElementById("savePhotoBtn").disabled = false;
  };
  reader.readAsDataURL(f);
});

document.getElementById("savePhotoBtn").addEventListener("click",()=>{
  if(!state?.coach?.id) return toast("Missing coach id.");
  if(!pendingDataUrl) return toast("Choose a photo first.");
  document.getElementById("savePhotoBtn").disabled = true;

  post("SAVE_COACH_PHOTO_DATAURL",{
    coachId: state.coach.id,
    dataUrl: pendingDataUrl
  });
});

// Tell Wix we’re ready
post("IFRAME_READY",{});
</script>

</body>
</html>
