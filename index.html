<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Coach Dashboard</title>
<style>
  :root{
    --panel:rgba(17,17,17,.88);
    --border:rgba(255,255,255,.10);
    --text:#fff;
    --muted:rgba(255,255,255,.62);
    --accent:#7B2EFF;
    --accent2:#B266FF;
    --clubGlow: rgba(123,46,255,.18);
    --radius:26px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:transparent;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}

  .stage{
    min-height:100vh;
    background:
      radial-gradient(1000px 600px at 20% -10%, rgba(255,255,255,.05), transparent 60%),
      linear-gradient(180deg,#000 0%,#050505 100%);
    position:relative;overflow:hidden;
  }
  .stage::before{
    content:"";position:absolute; inset:-40% -20%;
    transform:rotate(-14deg);
    background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.05), rgba(255,255,255,0));
    opacity:.18;pointer-events:none;
  }
  .stage::after{
    content:"";position:absolute; inset:0;
    background:radial-gradient(800px 520px at 80% 18%, var(--clubGlow), transparent 62%);
    opacity:.9;pointer-events:none;
    animation:glowPulse 2.8s ease-in-out infinite;
  }
  @keyframes glowPulse{ 0%{opacity:.55} 50%{opacity:1} 100%{opacity:.55} }

  .top{
    position:sticky;top:0;z-index:10;
    backdrop-filter: blur(14px);
    background: rgba(11,13,16,.72);
    border-bottom:1px solid var(--border);
  }
  .topInner{
    max-width:1200px;margin:0 auto;
    padding:16px 20px;
    display:flex;align-items:center;justify-content:space-between;
    position:relative;z-index:2;
  }
  .kicker{font-size:11px;font-weight:900;letter-spacing:1.6px;text-transform:uppercase;}
  .subkicker{margin-top:6px;font-size:12px;color:var(--muted);font-weight:650;}
  .pill{
    padding:10px 14px;border:1px solid rgba(255,255,255,.14);border-radius:999px;
    background:rgba(255,255,255,.04);font-size:12px;font-weight:800;
    position:relative;overflow:hidden;
  }
  .pill::after{
    content:"";position:absolute;left:12px;right:12px;bottom:8px;height:3px;border-radius:999px;
    background:linear-gradient(90deg, var(--accent), transparent);
    transform:scaleX(.35);transform-origin:left;transition:.18s ease;opacity:.95;
  }
  .pill:hover::after{transform:scaleX(1)}

  .page{max-width:1200px;margin:0 auto;padding:34px 20px 80px;position:relative;z-index:2}
  .hero{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:18px;gap:12px;flex-wrap:wrap;}
  .name{
    font-family:Impact,Haettenschweiler,'Arial Narrow Bold',sans-serif;
    font-size:52px;text-transform:uppercase;letter-spacing:1px;line-height:1;
    position:relative;padding-bottom:10px;
  }
  .name::after{
    content:"";position:absolute;left:0;bottom:0;height:6px;width:100%;
    border-radius:999px;
    background:linear-gradient(90deg, var(--accent), transparent);
    animation:underlineSweep 1.8s linear infinite;
  }
  @keyframes underlineSweep{
    0%{filter:brightness(1); transform:translateX(-2px)}
    50%{filter:brightness(1.12); transform:translateX(2px)}
    100%{filter:brightness(1); transform:translateX(-2px)}
  }
  .tag{
    padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.04);
    font-size:12px;font-weight:900;letter-spacing:1px;text-transform:uppercase;
    box-shadow:0 0 0 1px rgba(255,255,255,.03), 0 0 24px var(--clubGlow);
  }

  .grid{display:grid;grid-template-columns: 1.35fr 0.65fr;gap:14px;}
  @media(max-width:980px){ .grid{grid-template-columns:1fr;} }
  .stack{display:grid;gap:14px;}

  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:18px;
    padding:20px;
    position:relative;
    overflow:hidden;
  }
  .card::before{
    content:"";position:absolute; inset:-60% -20%;
    transform:rotate(-12deg);
    background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.05), rgba(255,255,255,0));
    opacity:.22;pointer-events:none;
  }
  .cardInner{position:relative;z-index:2}
  .cardStrong{box-shadow:0 0 0 1px rgba(255,255,255,.03), 0 0 32px var(--clubGlow);}

  .sectionTitle{
    font-family:Impact,Haettenschweiler,'Arial Narrow Bold',sans-serif;
    font-size:18px;text-transform:uppercase;letter-spacing:.8px;margin:0;padding-bottom:8px;
    position:relative;color:rgba(255,255,255,.92);
  }
  .sectionTitle::after{
    content:"";position:absolute;left:0;bottom:0;height:4px;width:100%;
    border-radius:999px;background:linear-gradient(90deg, var(--accent), transparent);
    transform:scaleX(.35);transform-origin:left;transition:.18s ease;opacity:.95;
  }
  .card:hover .sectionTitle::after{transform:scaleX(1)}

  .big{margin-top:12px;font-size:28px;font-weight:950;letter-spacing:-1px;}
  .sub{margin-top:10px;font-size:13px;color:var(--muted);white-space:pre-wrap;line-height:1.45;}
  .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}

  .select{
    padding:12px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.04);color:#fff;font-weight:800;letter-spacing:.2px;
    outline:none;min-width:240px;
  }
  .select option{color:#000;}

  .photoRow{display:flex;gap:14px;align-items:center;margin-top:14px;}
  .avatar{
    width:92px;height:92px;border-radius:18px;overflow:hidden;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.05);
    box-shadow:0 0 26px var(--clubGlow);
  }
  .avatar img{width:100%;height:100%;object-fit:cover}
  .fileRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}

  .btn{
    padding:12px 16px;border-radius:16px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.04);
    color:#fff;font-weight:900;letter-spacing:.7px;font-size:12px;text-transform:uppercase;
    cursor:pointer;transition:.14s ease;position:relative;overflow:hidden;
  }
  .btn::after{
    content:"";position:absolute;left:12px;right:12px;bottom:10px;height:4px;border-radius:999px;
    background:linear-gradient(90deg, var(--accent), transparent);
    transform:scaleX(0);transform-origin:left;transition:.18s ease;opacity:.95;
  }
  .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.18);box-shadow:0 0 28px var(--clubGlow);}
  .btn:hover::after{transform:scaleX(1)}
  .btn:active{transform:translateY(0px) scale(.99);}

  .scheduleActions{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap;}
</style>
</head>

<body>
<div class="stage">
  <div class="top">
    <div class="topInner">
      <div>
        <div class="kicker">ROLE: Coach</div>
        <div class="subkicker" id="clubText">CLUB: —</div>
      </div>
      <div class="pill" id="today">—</div>
    </div>
  </div>

  <div class="page">
    <div class="hero">
      <div class="name" id="coachName">LOADING</div>
      <div class="tag">COACH OPS</div>
    </div>

    <div class="grid">
      <div class="stack">
        <div class="card">
          <div class="cardInner">
            <div class="sectionTitle">Team</div>
            <div class="row" style="margin-top:10px;">
              <select class="select" id="teamSelect"></select>

              <div class="scheduleActions">
                <button class="btn" id="openScheduleListBtn">Schedule (List)</button>
                <button class="btn" id="openScheduleCalBtn">Schedule (Calendar)</button>
                <button class="btn" id="openCoachOfficeBtn">Coach Office</button>
              </div>
            </div>
            <div class="sub">Choose a team to load the next event.</div>
          </div>
        </div>

        <div class="card cardStrong">
          <div class="cardInner">
            <div class="sectionTitle">Next Event</div>
            <div class="big" id="eventTitle">—</div>
            <div class="sub" id="eventMeta">—</div>
          </div>
        </div>

        <div class="card">
          <div class="cardInner">
            <div class="sectionTitle">Club Alert</div>
            <div class="big" id="alertTitle">—</div>
            <div class="sub" id="alertMsg">—</div>
          </div>
        </div>
      </div>

      <div class="stack">
        <div class="card">
          <div class="cardInner">
            <div class="sectionTitle">Coach Profile</div>
            <div class="photoRow">
              <div class="avatar"><img id="avatarImg" alt="Coach photo"/></div>
              <div style="flex:1;">
                <div class="big" style="font-size:22px;margin-top:0;" id="coachMetaName">—</div>
                <div class="sub" id="coachMetaClub">—</div>

                <div class="fileRow" style="margin-top:12px;">
                  <input id="fileInput" type="file" accept="image/*" />
                  <button class="btn" id="savePhotoBtn" disabled>Save Photo</button>
                </div>

                <div class="sub" id="photoStatus" style="margin-top:10px;display:none;"></div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- right -->
    </div><!-- grid -->
  </div><!-- page -->
</div><!-- stage -->

<script>
let state = null;
let pendingDataUrl = "";

// ✅ EXACT theming function style from your working schedule html
function applyThemeFromPayload(payload){
  const theme = payload?.theme || null;

  const accent  = (theme?.accent  || "#7B2EFF");
  const accent2 = (theme?.accent2 || accent);
  const glow    = (theme?.glow    || "rgba(123,46,255,.18)");

  const r = document.documentElement.style;
  r.setProperty("--accent", accent);
  r.setProperty("--accent2", accent2);
  r.setProperty("--clubGlow", glow);
}

function post(msg){
  try { window.parent.postMessage(msg, "*"); } catch(_) {}
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function render(){
  if(!state) return;

  document.getElementById("clubText").textContent = "CLUB: " + (state.clubSlug || "—");
  document.getElementById("today").textContent = state.today || "—";

  const coachName = ((state.coach?.firstName||"") + " " + (state.coach?.lastName||"")).trim() || "COACH";
  document.getElementById("coachName").textContent = coachName.toUpperCase();
  document.getElementById("coachMetaName").textContent = coachName;
  document.getElementById("coachMetaClub").textContent = (state.clubSlug || "").toUpperCase();

  const photoUrl = (state.coach?.photoUrl || "").trim();
  document.getElementById("avatarImg").src = photoUrl || "data:image/svg+xml;base64," + btoa(`
    <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200">
      <rect width="100%" height="100%" fill="#111"/>
      <circle cx="100" cy="85" r="38" fill="#222"/>
      <rect x="45" y="130" width="110" height="50" rx="25" fill="#222"/>
    </svg>
  `);

  const sel = document.getElementById("teamSelect");
  const teams = Array.isArray(state.teams) ? state.teams : [];
  const selected = state.selectedTeamId || "";

  sel.innerHTML = teams.map(t => {
    const id = String(t.id||"");
    const name = String(t.name||id||"");
    const isSel = id === selected ? "selected" : "";
    return `<option value="${escapeHtml(id)}" ${isSel}>${escapeHtml(name)}</option>`;
  }).join("");

  const ev = state.nextEvent;
  document.getElementById("eventTitle").textContent = ev?.title || "No upcoming events";
  document.getElementById("eventMeta").textContent = ev
    ? `${ev.date || ""}${ev.time ? " • " + ev.time : ""}${ev.location ? "\n" + ev.location : ""}${ev.attendanceExpected ? "\nExpected: " + ev.attendanceExpected : ""}`
    : "—";

  const a = state.alert;
  document.getElementById("alertTitle").textContent = a?.title || "No alerts";
  document.getElementById("alertMsg").textContent = a?.message || "—";
}

window.addEventListener("message",(e)=>{
  const data = e.data || {};
  if (!data.type) return;

  // ✅ THEME message
  if (data.type === "THEME") {
    applyThemeFromPayload({ theme: data }); // wrap to match function signature
    return;
  }

  // ✅ DASH INIT message (flat, like schedule pages)
  if (data.type === "DASH_INIT") {
    // apply theme if included
    if (data.theme) applyThemeFromPayload(data);
    state = data;
    render();
    return;
  }

  if (data.type === "PHOTO_SAVED") {
    const ok = !!data.ok;
    const statusEl = document.getElementById("photoStatus");
    statusEl.style.display="block";
    statusEl.textContent = ok ? "Saved." : ("Upload failed: " + (data.message || "Unknown"));
    if (ok && data.url){
      document.getElementById("avatarImg").src = data.url;
      pendingDataUrl = "";
      document.getElementById("savePhotoBtn").disabled = true;
    }
    setTimeout(()=>{ statusEl.style.display="none"; }, 2500);
  }

  if (data.type === "TOAST") {
    // optional
  }
});

// UI events (flat messages)
document.getElementById("teamSelect").addEventListener("change",(ev)=>{
  post({ type:"SELECT_TEAM", teamId: ev.target.value });
});
document.getElementById("openScheduleListBtn").addEventListener("click",()=> post({ type:"OPEN_SCHEDULE_LIST" }));
document.getElementById("openScheduleCalBtn").addEventListener("click",()=> post({ type:"OPEN_SCHEDULE_CALENDAR" }));
document.getElementById("openCoachOfficeBtn").addEventListener("click",()=> post({ type:"OPEN_COACH_OFFICE" }));

document.getElementById("fileInput").addEventListener("change",(ev)=>{
  const f = ev.target.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    pendingDataUrl = reader.result;
    document.getElementById("avatarImg").src = pendingDataUrl;
    document.getElementById("savePhotoBtn").disabled = false;
  };
  reader.readAsDataURL(f);
});

document.getElementById("savePhotoBtn").addEventListener("click",()=>{
  if(!state?.coach?.id) return;
  if(!pendingDataUrl) return;
  document.getElementById("savePhotoBtn").disabled = true;

  post({
    type:"SAVE_COACH_PHOTO_DATAURL",
    coachId: state.coach.id,
    dataUrl: pendingDataUrl
  });
});

// Tell Wix we’re ready
post({ type:"IFRAME_READY" });
</script>
</body>
</html>
